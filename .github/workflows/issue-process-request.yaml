# On issue creation, process the request
name: Issue Process Request

permissions:
    issues: write
    contents: write
    pull-requests: write

on:
  issues:
    types: [opened]

env:
  BRANCH_NAME: "issue-${{ github.event.issue.number }}"

jobs:
    process-request:
        runs-on: ubuntu-latest
        steps:
        # Checkout repo
        - name: Checkout
          uses: actions/checkout@v3
        # Setup python
        - name: Setup Python
          uses: actions/setup-python@v2
          with:
            python-version: "3.11"
        - name: Process Request
          env:
            GH_ISSUE_TITLE: ${{ github.event.issue.title }}
            GH_ISSUE_BODY: ${{ github.event.issue.body }}
            GH_ISSUE_NUMBER: ${{ github.event.issue.number }}
            GH_ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |            
            python3 src/process_issue.py
        - name: Create branch
          uses: stefanzweifel/git-auto-commit-action@v4
          with:
            branch: ${{ env.BRANCH_NAME }}
            create_branch: true
        - name: Create PR
          env:
            GH_ISSUE_TITLE: ${{ github.event.issue.title }}
            GH_ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |
                pr_body="Request to install GitHub action by @${{ env.GH_ISSUE_AUTHOR }}
                
                Security checks will run against this PR to validate the security of the action. üïµÔ∏è
                PR will be updated with the results of the security checks. üìù
                Any issues found will be reported in the PR. üö®
                
                Findings should be reviewed by the requestor. üëÄ
                Final decision will be made by the repository owner. üëë                
                "
                gh pr create --title "GHA request: issue-${{ github.event.issue.number }} --body $pr_body --base main --head ${{ env.BRANCH_NAME }}"