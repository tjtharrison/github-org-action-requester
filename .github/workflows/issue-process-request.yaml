# On issue creation, process the request
name: Issue Process Request

permissions:
    issues: write
    contents: read
    pull-requests: write

on:
  issues:
    types: [opened]

env:
  BRANCH_NAME: "issue-${{ github.event.issue.number }}"

jobs:
    process-request:
        runs-on: ubuntu-latest
        steps:
        # Checkout repo
        - name: Checkout
          uses: actions/checkout@v3
        # Setup python
        - name: Setup Python
          uses: actions/setup-python@v2
          with:
            python-version: "3.11"
        - name: Process Request
          env:
            GH_ISSUE_TITLE: ${{ github.event.issue.title }}
            GH_ISSUE_BODY: ${{ github.event.issue.body }}
            GH_ISSUE_NUMBER: ${{ github.event.issue.number }}
            GH_ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: |            
            python3 src/process_issue.py
        - name: Create branch
          run: |
              git config --global user.name "github-actions[bot]"
              git config --global user.email "github-actions[bot]@users.noreply.github.com"
              git checkout -b ${{ env.BRANCH_NAME }}
              git add .
              git commit -m "Update PR with new action request"
              git push origin ${{ env.BRANCH_NAME }}
        - name: Create PR
          env:
            GH_ISSUE_TITLE: ${{ github.event.issue.title }}
            GH_ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          run: |
                gh pr create --title "GHA request: ${{ env.GH_ISSUE_TITLE }}" --body "Request to install GitHub action by @${{ env.GH_ISSUE_AUTHOR }}" --base main --head ${{ env.BRANCH_NAME }}